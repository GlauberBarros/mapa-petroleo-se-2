<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mapa Petróleo - Sergipe</title>

  <!-- OpenLayers -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css" />

  <style>
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; }
    #map { height: 100vh; width: 100vw; background: #f2f2f2; }

    .panel {
      position: absolute; top: 12px; left: 12px; z-index: 999;
      background: white; padding: 10px 12px; border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: 14px;
      min-width: 310px;
      max-width: 380px;
    }
    .panel label { display: flex; gap: 8px; align-items: center; margin-top: 6px; }
    .panel .muted { opacity: .75; font-size: 12px; margin-top: 6px; }
    .panel button { margin-top: 10px; width: 100%; cursor: pointer; }

    /* Tabela de status */
    .tbl {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 13px;
    }
    .tbl td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(0,0,0,.08);
      vertical-align: top;
    }
    .tbl td:last-child { text-align: right; }

    /* Legenda */
    .legend {
      position: absolute;
      bottom: 20px;
      left: 12px;
      background: white;
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: 13px;
      z-index: 999;
      min-width: 220px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 4px 0;
      gap: 8px;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 1px solid #000;
      flex: 0 0 auto;
    }
    .legend-line {
      width: 18px;
      height: 0;
      border-top: 3px solid #000;
      flex: 0 0 auto;
    }

    /* Popup */
    .popup {
      background: white;
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.18);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-size: 13px;
      max-width: 360px;
    }
    .popup .title { font-weight: 700; margin-bottom: 6px; }
    .popup .row { margin: 2px 0; }
    .popup .key { font-weight: 600; }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Painel principal -->
  <div class="panel">
    <div><b>Mapa Petróleo - SE</b></div>
    <div>Status: <span id="status">Carregando…</span></div>

    <label><input type="checkbox" id="chkAreas" checked> Áreas (CAMPOS-CARMO_ENERGY)</label>
    <label><input type="checkbox" id="chkPontos" checked> Pontos (Status - 25.11.2025)</label>

    <button id="btnRefit">Ajustar zoom</button>

    <div style="margin-top:10px">
      <b>Quantitativo por status</b>
      <table class="tbl" id="tabelaStatus"></table>
    </div>

    <div class="muted">
      Dica: se as camadas não aparecerem, abra F12 → Console e veja os logs.
    </div>
  </div>

  <!-- Legenda -->
  <div class="legend">
    <b>Status da medição</b>

    <div class="legend-item">
      <div class="legend-color" style="background: rgba(0,150,0,0.85)"></div>
      Medição encerrada
    </div>

    <div class="legend-item">
      <div class="legend-color" style="background: rgba(255,140,0,0.90)"></div>
      Medição não iniciada
    </div>

    <div class="legend-item">
      <div class="legend-color" style="background: rgba(0,90,200,0.90)"></div>
      Falta medição noturna
    </div>

    <div class="legend-item">
      <div class="legend-color" style="background: rgba(120,120,120,0.85)"></div>
      Outro / não informado
    </div>

    <div class="legend-item" style="margin-top:8px">
      <div class="legend-line"></div>
      Limites das áreas
    </div>
  </div>

  <!-- Popup -->
  <div id="popup" class="popup" style="display:none;"></div>

  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script>
    const statusEl = document.getElementById("status");
    function setStatus(msg) {
      statusEl.textContent = msg;
      console.log("[STATUS]", msg);
    }

    if (!window.ol) {
      setStatus("ERRO: OpenLayers não carregou (internet/bloqueio de CDN).");
      throw new Error("OpenLayers não carregou");
    }

    // ------------------------------------------------------------
    // Cache-busting simples
    // ------------------------------------------------------------
    const DATA_VERSION = 2;

    // URLs robustas para GitHub Pages
    const areasUrl  = new URL(`areas.geojson?v=${DATA_VERSION}`,  window.location.href).toString();
    const pontosUrl = new URL(`pontos.geojson?v=${DATA_VERSION}`, window.location.href).toString();

    console.log("areasUrl =", areasUrl);
    console.log("pontosUrl =", pontosUrl);

    // Base
    const osm = new ol.layer.Tile({ source: new ol.source.OSM() });

    // Formato GeoJSON (dados em lon/lat -> mapa em webmercator)
    const geojsonFormat = new ol.format.GeoJSON({
      dataProjection: "EPSG:4326",
      featureProjection: "EPSG:3857"
    });

    // Sources
    const areasSource  = new ol.source.Vector({ url: areasUrl,  format: geojsonFormat });
    const pontosSource = new ol.source.Vector({ url: pontosUrl, format: geojsonFormat });

    // Estilo das áreas
    const areasLayer = new ol.layer.Vector({
      source: areasSource,
      style: new ol.style.Style({
        stroke: new ol.style.Stroke({ color: "#000", width: 2 }),
        fill: new ol.style.Fill({ color: "rgba(0,0,0,0.12)" })
      })
    });

    // ------------------------------------------------------------
    // Helpers: normalizar texto e achar campo "status" mesmo com nome diferente
    // ------------------------------------------------------------
    function normalizeKey(s) {
      // remove acento, espaços e pontuações comuns para comparar chaves
      return String(s ?? "")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]/g, ""); // tira tudo que não for letra/número
    }

    function normalizeValue(s) {
      return String(s ?? "")
        .trim()
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    // tenta encontrar, entre as propriedades, uma chave que represente o status
    function getStatusRaw(feature) {
      const props = feature.getProperties();
      const keys = Object.keys(props || {});

      // candidatos normalizados (aceita variações: STATUS DA, STATUS DA MEDIÇÃO, STATUS_DA, etc.)
      const candidates = new Set([
        "statusdamedicao",
        "statusdamedicao",
        "statusda",
        "status",
        "statusdamedicao_", // só por segurança (não faz mal)
      ]);

      // 1) tenta bater por comparação normalizada
      for (const k of keys) {
        if (k === "geometry") continue;
        const nk = normalizeKey(k);
        if (candidates.has(nk)) return props[k];
      }

      // 2) fallback: procura qualquer chave que contenha "status"
      for (const k of keys) {
        if (k === "geometry") continue;
        const nk = normalizeKey(k);
        if (nk.includes("status")) return props[k];
      }

      return "";
    }

    // ------------------------------------------------------------
    // Classificação do STATUS DA MEDIÇÃO (valores)
    // ------------------------------------------------------------
    function normalizeStatusValue(raw) {
      const s = normalizeValue(raw);

      if (!s) return "Não informado";
      if (s.includes("encerrada")) return "Medição encerrada";
      if (s.includes("nao iniciada") || s.includes("não iniciada")) return "Medição não iniciada";
      if (s.includes("falta medicao noturna") || s.includes("falta medição noturna")) return "Falta medição noturna";

      return "Não informado";
    }

    // ------------------------------------------------------------
    // Estilo dinâmico dos pontos por STATUS (robusto)
    // ------------------------------------------------------------
    function estiloPontos(feature) {
      const raw = getStatusRaw(feature);
      const statusNorm = normalizeStatusValue(raw);

      let cor = "rgba(120,120,120,0.85)"; // padrão (cinza)
      if (statusNorm === "Medição encerrada") cor = "rgba(0,150,0,0.85)";
      else if (statusNorm === "Medição não iniciada") cor = "rgba(255,140,0,0.90)";
      else if (statusNorm === "Falta medição noturna") cor = "rgba(0,90,200,0.90)";

      return new ol.style.Style({
        image: new ol.style.Circle({
          radius: 6,
          fill: new ol.style.Fill({ color: cor }),
          stroke: new ol.style.Stroke({ color: "#000", width: 1 })
        })
      });
    }

    const pontosLayer = new ol.layer.Vector({
      source: pontosSource,
      style: estiloPontos
    });

    // Mapa
    const map = new ol.Map({
      target: "map",
      layers: [osm, areasLayer, pontosLayer],
      view: new ol.View({
        center: ol.proj.fromLonLat([-37.3, -10.7]),
        zoom: 8
      })
    });

    // ------------------------------------------------------------
    // Ajustar zoom para a extensão combinada
    // ------------------------------------------------------------
    function fitAll() {
      const extents = [];
      if (areasSource.getFeatures().length)  extents.push(areasSource.getExtent());
      if (pontosSource.getFeatures().length) extents.push(pontosSource.getExtent());

      if (!extents.length) {
        setStatus("Sem feições para ajustar zoom.");
        return;
      }

      let e = extents[0].slice();
      for (let i = 1; i < extents.length; i++) e = ol.extent.extend(e, extents[i]);

      map.getView().fit(e, { padding: [50, 50, 50, 50], maxZoom: 14 });
      setStatus("Zoom ajustado.");
    }

    document.getElementById("btnRefit").addEventListener("click", fitAll);

    // Toggle camadas
    document.getElementById("chkAreas").addEventListener("change", (e) => {
      areasLayer.setVisible(e.target.checked);
    });
    document.getElementById("chkPontos").addEventListener("change", (e) => {
      pontosLayer.setVisible(e.target.checked);
    });

    // ------------------------------------------------------------
    // Tabela de quantitativos por STATUS (robusto)
    // ------------------------------------------------------------
    function atualizarTabelaStatus() {
      const contagem = {
        "Medição encerrada": 0,
        "Medição não iniciada": 0,
        "Falta medição noturna": 0,
        "Não informado": 0
      };

      const feats = pontosSource.getFeatures();
      console.log("DEBUG: exemplo de chaves do 1º ponto:", feats[0] ? Object.keys(feats[0].getProperties()) : "(sem pontos)");

      feats.forEach(f => {
        const raw = getStatusRaw(f);
        const status = normalizeStatusValue(raw);
        contagem[status] = (contagem[status] || 0) + 1;
      });

      const tabela = document.getElementById("tabelaStatus");
      tabela.innerHTML = "";

      const ordem = [
        "Medição encerrada",
        "Medição não iniciada",
        "Falta medição noturna",
        "Não informado"
      ];

      let total = 0;
      for (const k of ordem) total += contagem[k] || 0;

      for (const k of ordem) {
        const qtd = contagem[k] || 0;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${k}</td><td><b>${qtd}</b></td>`;
        tabela.appendChild(tr);
      }

      const trTotal = document.createElement("tr");
      trTotal.innerHTML = `<td><b>Total</b></td><td><b>${total}</b></td>`;
      tabela.appendChild(trTotal);
    }

    // ------------------------------------------------------------
    // Popup (mantém comportamento de mostrar atributos)
    // ------------------------------------------------------------
    const popupEl = document.getElementById("popup");
    const overlay = new ol.Overlay({
      element: popupEl,
      positioning: "bottom-center",
      stopEvent: false,
      offset: [0, -12]
    });
    map.addOverlay(overlay);

    function formatProps(props) {
      const entries = Object.entries(props)
        .filter(([k]) => k !== "geometry")
        .slice(0, 18)
        .map(([k, v]) => `<div class="row"><span class="key">${k}:</span> ${String(v)}</div>`)
        .join("");
      return entries || "<div class='row'>Sem atributos.</div>";
    }

    map.on("singleclick", (evt) => {
      popupEl.style.display = "none";
      overlay.setPosition(undefined);

      const feature = map.forEachFeatureAtPixel(evt.pixel, (f) => f);
      if (!feature) return;

      const props = feature.getProperties();
      popupEl.innerHTML = `<div class="title">Detalhes</div>${formatProps(props)}`;
      popupEl.style.display = "block";
      overlay.setPosition(evt.coordinate);
    });

    // ------------------------------------------------------------
    // Carregamento e logs
    // ------------------------------------------------------------
    let loaded = 0;
    function onLoaded() {
      loaded += 1;
      if (loaded >= 2) {
        setStatus("Camadas carregadas.");
        atualizarTabelaStatus();
        fitAll();
      }
    }

    setStatus("Carregando camadas…");

    areasSource.on("featuresloadend", () => {
      console.log("Áreas carregadas:", areasSource.getFeatures().length);
      onLoaded();
    });
    areasSource.on("featuresloaderror", () => {
      console.error("Erro carregando áreas:", areasUrl);
      setStatus("ERRO ao carregar áreas (veja Console/Network).");
    });

    pontosSource.on("featuresloadend", () => {
      console.log("Pontos carregados:", pontosSource.getFeatures().length);
      onLoaded();
    });
    pontosSource.on("featuresloaderror", () => {
      console.error("Erro carregando pontos:", pontosUrl);
      setStatus("ERRO ao carregar pontos (veja Console/Network).");
    });
  </script>
</body>
</html>
